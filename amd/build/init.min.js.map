{"version":3,"file":"init.min.js","sources":["../src/init.js"],"sourcesContent":["/* eslint-disable */\nimport $ from 'jquery';\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nimport ChartJS from 'core/chartjs';\nimport ModalFactory from 'core/modal_factory';\nimport {downloadAsCSV, renderFailIcon, renderSuccessIcon} from './util'\n\n/**\n * This function acts as the main entry point and renderer for the plugin. It will attach to DOM elements created in\n * the templates/**.mustache, and populate them with data.\n *\n * @param {object} data Information about the scan queue and scan results\n * @param {object} data.totals\n * @param {number} data.totals.scanned How many document have been scanned\n * @param {number} data.totals.inqueue How many documents are waiting to be scanned\n * @param {number} data.totals.notinqueue How many documents are not yet in the queue\n * @param {object} data.pdfs\n * @param {object[]} data.pdfs.pass An array of PDFs that meet 100% of a11y checks performed by scanner\n * @param {object[]} data.pdfs.warn An array of PDFs that meet between 100% and 0% of a11y checks performed by scanner\n * @param {object[]} data.pdfs.fail An array of PDFs that meet 0% of a11y checks performed by scanner\n **/\nexport const init = (data) => {\n\n  console.log({ data })\n\n  /**\n   * Create stats breakdown in pie graph and attach to the DOM.\n   * Pie slices are pas, warn, and fail.\n   */\n  function renderPieChart() {\n\n    // Create the canvas element.\n    const canvas = $('<canvas/>')\n      .attr({\n        id: '#block-a11y-check-pie-chart-canvas',\n        'aria-label': 'A11y check pie chart describing the a11y status of the course PDFs.'\n      })\n\n    const ctx = canvas[0].getContext('2d')\n\n    // Append the canvas to the DOM.\n    $('#block-a11y-check-pie-chart-root')\n      .append(\n        $('<h6/>')\n          .addClass('mb-2')\n          .text('PDF Accessibility')\n      )\n      .append(canvas)\n\n    const chartData = {\n      labels: [`Pass (${data.pdfs.pass.length})`, `Warn (${data.pdfs.warn.length})`, `Fail (${data.pdfs.fail.length})`],\n      datasets: [{\n        label: 'A11y Check',\n        data: [\n          data.pdfs.pass.length,\n          data.pdfs.warn.length,\n          data.pdfs.fail.length\n        ],\n        backgroundColor: [\n          // Green.\n          '#5cb85c',\n          // Yellow.\n          '#f0ad4e',\n          // Red.\n          '#d9534f'\n        ]\n      }]\n    }\n    new ChartJS(ctx, {\n      type: 'pie',\n      data: chartData\n    })\n  }\n\n  function createNoDataParagraph() {\n    return $('<p/>')\n      .text(\"No data to show\")\n  }\n\n  /**\n   * Creates details table showing breakdown of stats returned by the scanner.\n   * @returns {*|jQuery|void}\n   */\n  function createDetailsTable() {\n    // Create the table content.\n    const $table = $('#block-a11y-check-details-table')\n      .append(\n        $('<table/>')\n          .addClass('table table-bordered table-hover table-responsive table-sm')\n          .append(\n            $('<thead/>')\n              .append(\n                $('<tr/>')\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Filename')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Bookmarks')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Lang')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Text')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Title')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Tagged')\n                  )\n                  .append(\n                    $('<th/>')\n                      .attr('scope', 'col')\n                      .text('Pages')\n                  )\n              )\n          )\n          .append('<tr/>')\n      )\n\n    // Create the table body.\n    const $tableBody = $('<tbody/>')\n\n    // Concatenate an array with all pdfs in data arg.\n    const pdfs = [].concat(\n      data.pdfs.pass,\n      data.pdfs.warn,\n      data.pdfs.fail\n    )\n\n    // Generate the table rows\n    const $tableRows = pdfs.map(\n      pdf => $('<tr/>')\n        .append(\n          $('<td/>')\n            .addClass('text-truncate')\n            .text(pdf.filename)\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.hasbookmarks === \"1\"\n              ? renderSuccessIcon()\n              : renderFailIcon())\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.haslanguage === \"1\"\n              ? renderSuccessIcon()\n              : renderFailIcon())\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.hastext === \"1\"\n              ? renderSuccessIcon()\n              : renderFailIcon())\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.hastitle === \"1\"\n              ? renderSuccessIcon()\n              : renderFailIcon())\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.istagged === \"1\"\n              ? renderSuccessIcon()\n              : renderFailIcon())\n        )\n        .append(\n          $('<td/>')\n            .text(pdf.pagecount >= 1\n              ? pdf.pagecount\n              : renderFailIcon())\n        )\n    )\n\n    // Append the table rows to the table.\n    $tableBody.append($tableRows.join(''))\n\n    return $table\n  }\n\n  /**\n   * Creates a download button that when clicked, downloads a CSV version of the table.\n   * @param $table\n   * @returns {*|jQuery|void}\n   */\n  function createDownloadButton($table) {\n    // Create the download to csv button.\n    return  $('button')\n      .addClass('btn btn-secondary mb-2')\n      .text('Download to CSV')\n      .click(() => downloadAsCSV($table))\n  }\n\n  /**\n   * Create the button element that when clicked, opens the modal.\n   * @param modal\n   * @returns {*|void}\n   */\n  function createModalTriggerButton(modal) {\n    // Create the button triggering the modal.\n    return $('button')\n      .addClass('btn btn-secondary')\n      .text('Details')\n      .click(() => modal.show())\n  }\n\n  /**\n   * Creates a modal window that displays a table of each PDF scanned by the plugin in the current course.\n   * @returns {Promise<*>}\n   */\n  async function createModal() {\n\n    const $table = createDetailsTable()\n\n    // Create the modal body first, so we can attach it during the modal's instantiation.\n    const $modalBody = $('<div/>')\n      .append(createDownloadButton($table))\n      .append($table)\n\n    // Create the modal.\n    const modal = await ModalFactory.create({\n      title: 'A11y Check Details',\n      body: $modalBody,\n      // TODO: Add last updated timestamp\n      footer: '<p>Last updated mm dd at ##:##:##</p>',\n      large: true\n    })\n\n    // This allows the modal to have 95% of screen width.\n    modal.getRoot()[0].childNodes[1].style.maxWidth = '95vw' || undefined\n\n    return modal\n  }\n\n  // Create the context. This gets passed to the template.\n  const context = {\n    name: 'A11y Check'\n  };\n\n  // This will call the function to load and render our template.\n  Templates.renderForPromise('block_a11y_check/summary', context)\n    .then(({html, js}) => {\n\n      // Render the template.\n      Templates.appendNodeContents(\"#block-a11y-check-root\", html, js);\n\n      // Create the modal.\n      createModal()\n        .then(modal => {\n\n        // Append the button trigger to the DOM.\n        $(\"#block-a11y-check-more-details-root\").append(\n          createModalTriggerButton(modal)\n        )\n\n        // Render the queue stats.\n        if (data.pdfs.pass.length > 0 || data.pdfs.warn.length > 0 || data.pdfs.fail.length > 0) {\n          renderPieChart()\n        } else {\n          $('#block-a11y-check-root').append(\n            createNoDataParagraph()\n          )\n        }\n\n        // TODO: Render the queue stats.\n\n      }).catch((error) => displayException(error));\n\n    })\n    // Deal with this exception (Using core/notify exception function is recommended).\n    .catch((error) => displayException(error));\n};\n"],"names":["data","createModal","$table","append","addClass","attr","text","$tableBody","$tableRows","concat","pdfs","pass","warn","fail","map","pdf","filename","hasbookmarks","haslanguage","hastext","hastitle","istagged","pagecount","join","createDetailsTable","$modalBody","click","createDownloadButton","modal","ModalFactory","create","title","body","footer","large","getRoot","childNodes","style","maxWidth","console","log","renderForPromise","name","then","_ref","html","js","appendNodeContents","show","createModalTriggerButton","length","canvas","id","ctx","getContext","chartData","labels","datasets","label","backgroundColor","ChartJS","type","renderPieChart","catch","error"],"mappings":"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"}