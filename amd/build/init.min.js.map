{"version":3,"file":"init.min.js","sources":["../src/init.js"],"sourcesContent":["/* eslint-disable */\nimport $ from 'jquery';\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nimport ChartJS from 'core/chartjs';\nimport ModalFactory from 'core/modal_factory';\nimport {download_table_as_csv, renderFailIcon, renderSuccessIcon} from './util'\n\nconst COLOR_PASS = '#198754'\nconst COLOR_CHECK = '#f0ad4e'\nconst COLOR_FAIL = '#d9534f'\n\nconst LANG_CHECK_URL = 'https://www.adobe.com/accessibility/pdf/pdf-accessibility-overview.html'\nconst OUTLINE_CHECK_URL = 'https://www.adobe.com/accessibility/pdf/pdf-accessibility-overview.html'\nconst TITLE_CHECK_URL = 'https://www.adobe.com/accessibility/pdf/pdf-accessibility-overview.html'\nconst TEXT_CHECK_URL = 'https://www.adobe.com/accessibility/pdf/pdf-accessibility-overview.html'\n\n/**\n * This function acts as the main entry point and renderer for the plugin. It will attach to DOM elements created in\n * the templates/**.mustache, and populate them with data.\n *\n * @param {object} data Information about the scan queue and scan results\n * @param {object} data.totals\n * @param {number} data.totals.scanned How many document have been scanned\n * @param {number} data.totals.inqueue How many documents are waiting to be scanned\n * @param {number} data.totals.notinqueue How many documents are not yet in the queue\n * @param {object} data.pdfs\n * @param {object[]} data.pdfs.pass An array of PDFs that meet 100% of a11y checks performed by scanner\n * @param {object[]} data.pdfs.warn An array of PDFs that meet between 100% and 0% of a11y checks performed by scanner\n * @param {object[]} data.pdfs.fail An array of PDFs that meet 0% of a11y checks performed by scanner\n **/\nexport const init = (data, courseid) => {\n\n  /**\n   * Get the last scanned file from {data}\n   * @return string\n   */\n  function getLastScanned() {\n    const allPdfs = [].concat(data.pdfs.pass, data.pdfs.warn, data.pdfs.fail)\n    if (allPdfs.length > 0) {\n      const max = allPdfs.reduce((a, b) => (+a.lastchecked > +b.lastchecked) ? a : b)\n      if (max) {\n        const date = new Date(+max.lastchecked * 1000)\n        return `Last scanned ${date.toDateString()} at ${date.toLocaleTimeString()}`\n      } else {\n        return ''\n      }\n    } else {\n      return ''\n    }\n  }\n\n  /**\n   * Create stats breakdown in pie graph and attach to the DOM.\n   * Pie slices are pas, warn, and fail.\n   */\n  function renderPieChart() {\n\n    // Create the canvas element.\n    const canvas = $('<canvas/>')\n      .attr({\n        id: '#block-accessibility-filescan-pie-chart-canvas',\n        'aria-label': 'Pie chart describing the accessibility status of this course\\'s PDFs.'\n      })\n\n    const ctx = canvas[0].getContext('2d')\n\n    // Append the canvas to the DOM.\n    $('#block-accessibility-filescan-pie-chart-root')\n      .addClass(\"mb-2 w-100\")\n      .append(\n        $('<h6/>')\n          .addClass('mb-2')\n          // TODO: Text label should be a string in lang/en/block_accessibility_filescan.php\n          .text('Accessibility of Course PDFs')\n      )\n      .append(canvas)\n\n    const chartData = {\n      labels: [\n        `Satisfies all checks (${data.pdfs.pass.length})`,\n        `Satisfies some checks (${data.pdfs.warn.length})`,\n        `Satisfies no checks (${data.pdfs.fail.length})`\n      ],\n      datasets: [{\n        label: 'PDFs',\n        data: [\n          data.pdfs.pass.length,\n          data.pdfs.warn.length,\n          data.pdfs.fail.length\n        ],\n        backgroundColor: [\n          COLOR_PASS,\n          COLOR_CHECK,\n          COLOR_FAIL\n        ]\n      }]\n    }\n    new ChartJS(ctx, {\n      type: 'pie',\n      data: chartData\n    })\n  }\n\n  function createNoDataParagraph() {\n    return $('<p/>')\n      .text(\"No data to show ðŸ˜¢\")\n  }\n\n  /**\n   * Creates details table showing breakdown of stats returned by the scanner.\n   * @returns {*|jQuery|void}\n   */\n  async function createDetailsTable() {\n\n    // Create the table content.\n    const $table = $('<table/>')\n      .attr('id', 'block-accessibility-filescan-table')\n      .addClass('table table-bordered table-hover w-100')\n      .append(\n        $('<thead/>')\n          .addClass('mw-100 w-100')\n          .append(\n            $('<tr/>')\n              .addClass('mw-100 w-100')\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Filename')\n              )\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Lang')\n                  .append(\n                    $('<i/>')\n                      .attr('type', 'button')\n                      .attr('class', 'ml-2 fa-solid fa-circle-info text-info')\n                      .click(() => {\n                        const newWindow = window.open(LANG_CHECK_URL, 'height=600,width=600')\n                        if (window.focus) {\n                          newWindow.focus()\n                        }\n                      })\n                  )\n              )\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Text')\n                  .append(\n                    $('<i/>')\n                      .attr('type', 'button')\n                      .attr('class', 'ml-2 fa-solid fa-circle-info text-info')\n                      .click(() => {\n                        const newWindow = window.open(TEXT_CHECK_URL, 'height=600,width=600')\n                        if (window.focus) {\n                          newWindow.focus()\n                        }\n                      })\n                  )\n              )\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Title')\n                  .append(\n                    $('<i/>')\n                      .attr('type', 'button')\n                      .attr('class', 'ml-2 fa-solid fa-circle-info text-info')\n                      .click(() => {\n                        const newWindow = window.open(TITLE_CHECK_URL, 'height=600,width=600')\n                        if (window.focus) {\n                          newWindow.focus()\n                        }\n                      })\n                  )\n              )\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Tagged')\n                  .append(\n                    $('<i/>')\n                      .attr('type', 'button')\n                      .attr('class', 'ml-2 fa-solid fa-circle-info text-info')\n                      .click(() => {\n                        const newWindow = window.open(OUTLINE_CHECK_URL, 'height=600,width=600')\n                        if (window.focus) {\n                          newWindow.focus()\n                        }\n                      })\n                  )\n              )\n              .append(\n                $('<th/>')\n                  .attr('scope', 'col')\n                  .text('Pages')\n              )\n          )\n      )\n    // Create the table body.\n    const $tableBody = $('<tbody/>')\n\n    // Concatenate an array with all pdfs in data arg.\n    const pdfs = [].concat(\n      data.pdfs.pass,\n      data.pdfs.warn,\n      data.pdfs.fail\n    )\n\n    // Generate the table rows\n    const $tableRows = pdfs.map(\n      pdf => $('<tr/>')\n        .addClass('w-100')\n        .append(\n          $('<td/>')\n            .addClass('text-truncate')\n            .attr('style', 'max-width: 300px;')\n            .append(\n              $('<a/>')\n                .attr('href', pdf.url)\n                .text(pdf.filename)\n            )\n        )\n        .append(\n          $('<td/>')\n            .append(pdf.haslanguage === \"1\"\n              ? $(renderSuccessIcon())\n              : $(renderFailIcon()))\n        )\n        .append(\n          $('<td/>')\n            .append(pdf.hastext === \"1\"\n              ? $(renderSuccessIcon())\n              : $(renderFailIcon()))\n        )\n        .append(\n          $('<td/>')\n            .append(pdf.hastitle === \"1\"\n              ? $(renderSuccessIcon())\n              : $(renderFailIcon()))\n        )\n        .append(\n          $('<td/>')\n            .append(pdf.istagged === \"1\"\n              ? $(renderSuccessIcon())\n              : $(renderFailIcon()))\n        )\n        .append(\n          $('<td/>')\n            .append(pdf.pagecount >= 1\n              ? $('<span/>').text(pdf.pagecount)\n              : $(renderFailIcon()))\n        )\n    )\n\n    // Append the table rows to the table.\n    $tableBody.append($tableRows)\n    $table.append($tableBody)\n\n    return $table\n  }\n\n  /**\n   * Creates a download button that when clicked, downloads a CSV version of the table.\n   * @returns {*|jQuery|void}\n   */\n  function createDownloadButton() {\n    // Create the download to csv button.\n    return $('<button/>')\n      .addClass('btn btn-secondary mb-2')\n      .text('Download to CSV')\n      .click(() => download_table_as_csv('block-accessibility-filescan-table'))\n  }\n\n  /**\n   * Create the button element that when clicked, opens the modal.\n   * @param modal\n   * @returns {*|void}\n   */\n  function createModalTriggerButton(modal) {\n    // Create the button triggering the modal.\n    return $('<button/>')\n      .addClass('btn btn-secondary')\n      .text('Details')\n      .click(() => {\n        // Dispatch event to invalidate the block's cache\n        //dispatchEvent(\"\\\\block_a11y_check\\\\event\\\\invalidate_results_cache\" , { courseid: +courseid })\n        // Show the modal\n        modal.show()\n      })\n  }\n\n  /**\n   * Creates a modal window that displays a table of each PDF scanned by the plugin in the current course.\n   * @returns {Promise<*>}\n   */\n  async function createModal() {\n\n    const $table = await createDetailsTable()\n\n    // Create the modal body first, so we can attach it during the modal's instantiation.\n    const $modalBody = $('<div/>')\n      .append(createDownloadButton($table))\n      .append(\n        $('<div/>')\n          .addClass('table-responsive')\n        )\n        .append($table)\n\n    // Create the modal.\n    const modal = await ModalFactory.create({\n      title: 'Accessibility of Course PDFs - Details',\n      body: $modalBody,\n      footer: $('<p/>')\n        .text(\n          getLastScanned()\n        ),\n      large: true\n    })\n\n    // This allows the modal to have 95% of screen width.\n    modal.getRoot()[0].childNodes[1].style.maxWidth = '95vw' || undefined\n\n    return modal\n  }\n\n  // Create the context. This gets passed to the template.\n  const context = {\n    name: 'A11y Check'\n  };\n\n  // This will call the function to load and render our template.\n  Templates.renderForPromise('block_accessibility_filescan/summary', context)\n    .then(({html, js}) => {\n\n      // Render the template.\n      Templates.appendNodeContents(\"#block-accessibility-filescan-root\", html, js);\n\n      // Create the modal.\n      createModal()\n        .then(modal => {\n\n          // Render the queue stats.\n          if (data.pdfs.pass.length > 0 || data.pdfs.warn.length > 0 || data.pdfs.fail.length > 0) {\n            // Render the pie chart.\n            renderPieChart()\n\n            // Append the button trigger to the DOM.\n            $(\"#block-accessibility-filescan-more-details-root\")\n              .addClass('mb-2')\n              .append(\n                createModalTriggerButton(modal)\n              )\n              .append(\n                $('<p/>')\n                  .addClass('mt-3')\n                  .append(\n                    $('<small/>')\n                      .text(\n                        getLastScanned()\n                      )\n                  )\n              )\n          } else {\n            $('#block-accessibility-filescan-root').append(\n              createNoDataParagraph()\n            )\n          }\n\n        }).catch((error) => displayException(error));\n\n    })\n    // Deal with this exception (Using core/notify exception function is recommended).\n    .catch((error) => displayException(error));\n};\n"],"names":["data","courseid","getLastScanned","allPdfs","concat","pdfs","pass","warn","fail","length","max","reduce","a","b","lastchecked","date","Date","toDateString","toLocaleTimeString","createModal","$table","attr","addClass","append","text","click","newWindow","window","open","focus","$tableBody","$tableRows","map","pdf","url","filename","haslanguage","hastext","hastitle","istagged","pagecount","createDetailsTable","$modalBody","modal","ModalFactory","create","title","body","footer","large","getRoot","childNodes","style","maxWidth","renderForPromise","name","then","_ref","html","js","appendNodeContents","canvas","id","ctx","getContext","chartData","labels","datasets","label","backgroundColor","ChartJS","type","renderPieChart","show","createModalTriggerButton","catch","error"],"mappings":"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"}